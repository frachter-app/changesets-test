name: Deploy on Release

on:
  push:
    branches:
      - main

jobs:
  # -------------------------
  # ORCHESTRATOR
  # -------------------------
  orchestrator:
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.detect.outputs.is_release }}
      released: ${{ steps.detect.outputs.released }}
    steps:
      - uses: actions/checkout@v4
        with:
          # Critical: fetch-depth 0 is required to inspect commit history (HEAD^2)
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3

      - name: Detect Release & Apps
        id: detect
        run: bun run scripts/detect-release.ts

  # -------------------------
  # BACKEND
  # -------------------------
  deploy-backend:
    needs: orchestrator
    # Logic: Must be a release AND backend must be in the list
    if: |
      needs.orchestrator.outputs.is_release == 'true' && 
      contains(fromJSON(needs.orchestrator.outputs.released), 'backend')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy Backend
        run: echo "üöÄ Deploying Backend..."

  # -------------------------
  # CLOUDPRINT
  # -------------------------
  deploy-cloudprint:
    needs: [orchestrator, deploy-backend]
    # Logic:
    # 1. Must be a release
    # 2. Must be in the list
    # 3. Wait for backend (Success or Skipped)
    if: |
      always() &&
      needs.orchestrator.outputs.is_release == 'true' && 
      contains(fromJSON(needs.orchestrator.outputs.released), 'cloudprint') && 
      (needs.deploy-backend.result == 'success' || needs.deploy-backend.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy Cloudprint
        run: echo "üñ®Ô∏è Deploying Cloudprint..."

  # -------------------------
  # FRACHTER
  # -------------------------
  deploy-frachter:
    needs: [orchestrator, deploy-backend]
    if: |
      always() &&
      needs.orchestrator.outputs.is_release == 'true' && 
      contains(fromJSON(needs.orchestrator.outputs.released), 'frachter') && 
      (needs.deploy-backend.result == 'success' || needs.deploy-backend.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy Frachter
        run: echo "üö¢ Deploying Frachter..."
